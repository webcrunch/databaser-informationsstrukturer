services:
  # 1. Relationsdatabas: PostgreSQL (Robust standardval)
  postgres_db:
    image: postgres:latest
    container_name: mai25ma_postgres
    restart: always
    environment:
      POSTGRES_USER: user # Applikationsanv칛ndare
      POSTGRES_PASSWORD: password
      POSTGRES_DB: main_database

      # 游 NYTT: Skapa en separat administrativ/superanv칛ndare
      POSTGRES_SUPERUSER: owneruser # Anv칛ndarnamn f칬r den nya 칛garen
      POSTGRES_SUPERUSER_PASSWORD: securepassword # L칬senord f칬r den nya 칛garen
    # environment:
    # POSTGRES_USER: user
    # POSTGRES_PASSWORD: password
    # POSTGRES_DB: main_database
    ports:
      - "5432:5432" # GUI-anslutning: localhost:5432
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # 1A. GUI f칬r PostgreSQL: pgAdmin
  pgadmin:
    image: dpage/pgadmin4
    container_name: mai25ma_pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: verysecurepassword
      PGADMIN_SERVER_URL: postgres_db:5432
    ports:
      - "5050:80" # pgAdmin GUI n친s p친 http://localhost:5050
    depends_on:
      - postgres_db

  # ---------------------------------
  # 1. Relationsdatabas: MySQL (Scratchpad/칐vning)
  # ---------------------------------
  # 2. Relationsdatabas: MySQL (Alternativ f칬r projekt eller 칬vning samt inga init skript k칬rs n칛r den startar)
  mysql_db:
    image: mysql:8.0
    container_name: mai25ma_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: main_database
      MYSQL_USER: user
      MYSQL_PASSWORD: password
    ports:
      - "3307:3306" # GUI-anslutning: localhost:3307
    volumes:
      - mysql_scratch_data:/var/lib/mysql
      - ./user-upgrade:/docker-entrypoint-initdb.d
  # ---------------------------------
  # Databastj칛nsten f칬r den examinerade uppgiften (MySQL/MariaDB)
  # ---------------------------------
  # 2. Relationsdatabas: MySQ
  mysql_nexus_db:
    image: mysql:8.0
    container_name: mai25ma_nexus_proj
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: Nexus_DB
      MYSQL_USER: nexusUser
      MYSQL_PASSWORD: anotherPassword
    ports:
      - "3306:3306" # GUI-anslutning: localhost:3306
    volumes:
      - mysql_nexus_data:/var/lib/mysql #
      - ./init-scripts:/docker-entrypoint-initdb.d

  # arbeta med adminer ist칛llet
  # L칛gg till detta som en ny service i din docker-compose.yml
  adminer:
    image: adminer:latest
    container_name: mai25ma_adminer
    restart: always
    ports:
      - "8085:8080" # Adminer GUI n친s p친 http://localhost:8080 (Eller v칛lj valfri ledig port)
    depends_on:
      - postgres_db # Beror p친 b친da databaserna
      - mysql_db
      - mysql_nexus_db

  # 3. Modelleringsverktyg A: DrawDB (Schema Editor)
  drawdb:
    # OBS! ANV츿ND NU DENNA GHCR.IO-L츿NK
    image: ghcr.io/drawdb-io/drawdb:latest
    container_name: mai25ma_drawdb
    ports:
      - "3000:80" # DrawDB n친s p친 http://localhost:3000
    restart: unless-stopped
  # 4. Modelleringsverktyg B: draw.io (Allm칛n Diagram Editor)

  drawio:
    image: jgraph/drawio:latest
    container_name: mai25ma_drawio
    ports:
      - "8080:8080" # draw.io n친s p친 http://localhost:8080
    restart: unless-stopped
    # draw.io sparar som filer p친 din dator eller till molntj칛nster,
    # s친 ingen volym beh칬vs heller h칛r.

  # 3. NoSQL: MongoDB (Dokumentdatabas f칬r kurs칬versikten)
  mongo:
    image: mongo:latest
    container_name: mai25ma_mongo
    restart: always
    environment:
      # --- ADMIN ANV츿NDARE ---
      MONGO_INITDB_ROOT_USERNAME: adminuser
      MONGO_INITDB_ROOT_PASSWORD: password

      # --- SKAPA EN INITIAL DATABAS ---
      MONGO_INITDB_DATABASE: main_database
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    # 游 NYTT: Healthcheck f칬r att se om databasen 칛r redo
    healthcheck:
      # Detta kommando pingar databasen med admin-uppgifterna
      test: |
        mongosh --port 27017 \
                --username ${MONGO_INITDB_ROOT_USERNAME} \
                --password ${MONGO_INITDB_ROOT_PASSWORD} \
                --authenticationDatabase admin \
                --eval "db.adminCommand('ping')"
      interval: 10s # K칬r testet var 10:e sekund
      timeout: 5s # Ge kommandot 5s att svara
      retries: 12 # F칬rs칬k 12 g친nger (totalt 2 min)
      start_period: 30s # Ge databasen 30s att starta innan f칬rsta testet

  # 3A. GUI f칬r MongoDB: Mongo Express
  mongo_express:
    image: mongo-express
    container_name: mai25ma_mongoexpress
    restart: always
    environment:
      # 1. Hostnamn f칬r Docker-skriptet
      MONGODB_SERVER: mongo
      # 2. Hostnamn f칬r Mongo Express-appen
      ME_CONFIG_MONGODB_SERVER: mongo
      # 3. Anv칛ndaruppgifter f칬r WEB-GUI
      ME_CONFIG_BASICAUTH_USERNAME: adminuser
      ME_CONFIG_BASICAUTH_PASSWORD: password
      # 4. Talar om att admin-autentisering anv칛nds
      ME_CONFIG_MONGODB_ENABLE_ADMIN: "true"
      # 5. Talar om vilken databas den ska autentisera mot
      ME_CONFIG_MONGODB_AUTH_DATABASE: admin
      # 6. Anv칛ndaruppgifter f칬r DATABAS-ANSLUTNINGEN
      ME_CONFIG_MONGODB_ADMINUSERNAME: adminuser
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
    ports:
      - "8081:8081"
    # 游 UPPDATERAD: V칛nta tills 'mongo'-tj칛nsten 칛r 'healthy'
    depends_on:
      mongo:
        condition: service_healthy

  # mongo_express:
  #   image: mongo-express
  #   container_name: mai25ma_mongoexpress
  #   restart: always
  #   environment:
  #     ME_CONFIG_MONGODB_SERVER: mongo_db
  #     ME_CONFIG_MONGODB_ADMINUSERNAME: adminuser
  #     ME_CONFIG_MONGODB_ADMINPASSWORD: password
  #     ME_CONFIG_MONGODB_ENABLE_ADMIN: "true"
  #     ME_CONFIG_MONGODB_AUTH_DATABASE: admin

  #     # BasicAuth f칬r sj칛lva web GUI:t
  #     ME_CONFIG_BASICAUTH_USERNAME: admin
  #     ME_CONFIG_BASICAUTH_PASSWORD: secret
  #   ports:
  #     - "8081:8081"
  #   depends_on:
  #     - mongo_db

  # 4. NoSQL: Redis (Key-Value Store f칬r kurs칬versikten)
  redis_cache:
    image: redis:latest
    container_name: mai25ma_redis
    restart: always
    ports:
      - "6379:6379" # GUI-anslutning: localhost:6379
    volumes:
      - redis_data:/data

  # 4A. GUI f칬r Redis: RedisInsight (Officiellt webbgr칛nssnitt)
  # redis_insight:
  #   image: redis/redisinsight:latest
  #   container_name: mai25ma_redisinsight
  #   restart: always
  #   ports:
  #     - "7777:8001" # RedisInsight GUI n친s p친 http://localhost:8001
  #   depends_on:
  #     - redis_cache # Startar efter Redis

  redis_commander:
    image: rediscommander/redis-commander
    container_name: mai25ma_rediscommander
    restart: always
    environment:
      # Anv칛nd Containernamnet f칬r anslutning
      REDIS_HOSTS: local_redis:redis_cache:6379
    ports:
      - "8082:8081" # GUI n친s p친 http://localhost:8082
    depends_on:
      - redis_cache

  # ---------------------------------
  # Applikationstj칛nsten (Flask API)
  # ---------------------------------
  api:
    build: ./backend
    container_name: swagger_api_exam
    restart: always
    ports:
      - "5000:5000"
    environment:
      # S칛tter FLASK_APP s친 att 'flask run' vet att den ska k칬ra backend.py
      FLASK_APP: backend.py

      # V칛rdnamnet f칬r databasen 칛r namnet p친 Docker-tj칛nsten
      MYSQL_DATABASE_HOST: mysql_nexus_db

      # M친ste matcha MYSQL_DATABASE i mysql_db-tj칛nsten
      MYSQL_DATABASE_DB: Nexus_DB

      # M친ste matcha MYSQL_USER i mysql_db-tj칛nsten
      MYSQL_DATABASE_USER: nexusUser

      # M친ste matcha MYSQL_PASSWORD i mysql_db-tj칛nsten
      MYSQL_DATABASE_PASSWORD: anotherPassword

    # Anv칛nd 'flask run' kommandot f칬r att starta
    command: flask run --host 0.0.0.0

    depends_on:
      - mysql_nexus_db # S칛kerst칛ller att databasen startas innan API:et  # 5. Din Framtida Applikation (Avkommenteras vid projektstart)

  # app_server:
  #   build: .
  #   container_name: mai25ma_app
  #   ports:
  #     - "8080:8080"
  #   depends_on:
  #     - postgres_db
  #   environment:
  #     DB_HOST: postgres_db
  #     DB_NAME: main_database

volumes:
  postgres_data:
  mysql_scratch_data: # <-- NY VOLYM
  mysql_nexus_data: # <-- NY VOLYM:
  mongo_data:
  redis_data:
